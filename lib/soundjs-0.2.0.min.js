/**
* SoundJS
* Visit http://createjs.com/ for documentation, updates and examples.
*
* Copyright (c) 2012 Grant Skinner
* 
* Permission is hereby granted, free of charge, to any person
* obtaining a copy of this software and associated documentation
* files (the "Software"), to deal in the Software without
* restriction, including without limitation the rights to use,
* copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the
* Software is furnished to do so, subject to the following
* conditions:
* 
* The above copyright notice and this permission notice shall be
* included in all copies or substantial portions of the Software.
* 
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
* OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
* HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
* WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
* FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
* OTHER DEALINGS IN THE SOFTWARE.
**/
(function(i){function a(){throw"SoundJS cannot be instantiated";}function g(a,c){this.init(a,c)}a.DELIMITER="|";a.AUDIO_TIMEOUT=8E3;a.INTERRUPT_ANY="any";a.INTERRUPT_EARLY="early";a.INTERRUPT_LATE="late";a.INTERRUPT_NONE="none";a.PLAY_INITED="playInited";a.PLAY_SUCCEEDED="playSucceeded";a.PLAY_INTERRUPTED="playInterrupted";a.PLAY_FINISHED="playFinished";a.PLAY_FAILED="playFailed";a.activePlugin=null;a.pluginsRegistered=false;a.masterVolume=1;a.muted=false;a.instances=[];a.instanceHash={};a.idHash=
null;a.getPreloadHandlers=function(){return{callback:a.proxy(a.initLoad,a),types:["sound"],extensions:["mp3","ogg","wav"]}};a.registerPlugins=function(b){a.pluginsRegistered=true;for(var c=0,d=b.length;c<d;c++){var e=b[c];if(e!=null&&e.isSupported())return a.activePlugin=new e,true}return false};a.registerPlugin=function(b){a.pluginsRegistered=true;return b.isSupported()?(a.activePlugin=new b,a.log("initialize "+a.activePlugin.toString()),true):false};a.isReady=function(){return a.activePlugin!=null};
a.getCapabilities=function(){return a.activePlugin?a.activePlugin.capabilities:null};a.getCapability=function(b){return a.activePlugin==null?null:a.activePlugin.capabilities[b]};a.initLoad=function(b,c,d,e){if(!a.checkPlugin(true))return false;b=a.parsePath(b,c,d,e);if(b==null)return false;if(d!=null){if(a.idHash==null)a.idHash={};a.idHash[d]=b.src}g.create(b.src,e);d=a.activePlugin.register(b.src,e);if(d!=null){if(d.tag!=null)b.tag=d.tag;else if(d.src)b.src=d.src;if(d.completeHandler!=null)b.handler=
d.completeHandler}return b};a.parsePath=function(b,c,d,e){for(var b=b.split(a.DELIMITER),c={type:c||"sound",id:d,data:e,handler:a.handleSoundReady},d=false,e=a.getCapabilities(),f=0,g=b.length;f<g;f++){var h=b[f],j=h.lastIndexOf("."),i=h.substr(j+1).toLowerCase(),j=h.substr(0,j).split("/").pop();switch(i){case "mp3":e.mp3&&(d=true);break;case "ogg":e.ogg&&(d=true);break;case "wav":e.wav&&(d=true)}if(d)return c.name=j,c.src=h,c.extension=i,c}return null};a.play=function(b,c,d,e,f,g,h){if(!a.checkPlugin(true))return null;
b=a.getSrcFromId(b);b=a.activePlugin.create(b);return a.playInstance(b,c,d,e,f,g,h)};a.playInstance=function(b,c,d,e,f,g,h){c=c||a.INTERRUPT_NONE;d==null&&(d=0);e==null&&(e=0);f==null&&(f=0);g==null&&(g=1);h==null&&(h=0);if(d==0){if(!a.beginPlaying(b,c,e,f,g,h))return null}else setTimeout(function(){a.beginPlaying(b,c,e,f,g,h)},d);this.instances.push(b);return this.instanceHash[b.uniqueId]=b};a.beginPlaying=function(a,c,d,e,f,i){if(!g.add(a,c))return false;return a.beginPlaying(d,e,f,i)==-1?(this.instances.splice(this.instances.indexOf(a),
1),delete this.instanceHash[a.uniqueId],false):true};a.checkPlugin=function(b){return a.activePlugin==null&&(b&&!a.pluginsRegistered&&a.registerPlugin(a.HTMLAudioPlugin),a.activePlugin==null)?(a.log("*** No Active Plugin Found on SoundJS"),false):true};a.getSrcFromId=function(b){return a.idHash==null||a.idHash[b]==null?b:a.idHash[b]};a.setVolume=function(b,c){if(Number(b)==null)return false;b=Math.max(0,Math.min(1,b));return a.tellAllInstances("setVolume",c,b)};a.getMasterVolume=function(){return a.masterVolume};
a.setMasterVolume=function(b){a.masterVolume=b;return a.tellAllInstances("setMasterVolume",null,b)};a.setMute=function(b,c){return a.tellAllInstances("mute",c,b)};a.pause=function(b){return a.tellAllInstances("pause",b)};a.resume=function(b){return a.tellAllInstances("resume",b)};a.stop=function(b){return a.tellAllInstances("stop",b)};a.getInstanceById=function(a){return this.instanceHash[a]};a.playFinished=function(a){g.remove(a);this.instances.splice(this.instances.indexOf(a),1)};a.tellAllInstances=
function(a,c,d){if(this.activePlugin==null)return false;for(var c=this.getSrcFromId(c),e=this.instances.length-1;e>=0;e--){var f=this.instances[e];if(!(c!=null&&f.src!=c))switch(a){case "pause":f.pause();break;case "resume":f.resume();break;case "setVolume":f.setVolume(d);break;case "setMasterVolume":f.setMasterVolume(d);break;case "mute":f.mute(d);break;case "stop":f.stop();break;case "setPan":f.setPan(d)}}return true};a.proxy=function(a,c){return function(){return a.apply(c,arguments)}};a.log=function(){};
i.SoundJS=a;g.channels={};g.create=function(a,c){var d=g.get(a);d==null?g.channels[a]=new g(a,c):d.max+=c};g.add=function(a,c){var d=g.get(a.src);return d==null?false:d.add(a,c)};g.remove=function(a){var c=g.get(a.src);if(c==null)return false;c.remove(a);return true};g.get=function(a){return g.channels[a]};g.prototype={src:null,max:null,length:0,init:function(a,c){this.src=a;this.max=c||1;this.instances=[]},get:function(a){return this.instances[a]},add:function(a,c){if(!this.getSlot(c,a))return false;
this.instances.push(a);this.length++;return true},remove:function(a){a=this.instances.indexOf(a);if(a==-1)return false;this.instances.splice(a,1);this.length--;return true},getSlot:function(b){for(var c,d,e=0,f=this.max||100;e<f;e++){c=this.get(e);if(c==null)return true;else if(b==a.INTERRUPT_NONE)continue;if(e==0)d=c;else if(c.playState==a.PLAY_FINISHED||c==a.PLAY_INTERRUPTED||c==a.PLAY_FAILED)d=c;else if(b==a.INTERRUPT_EARLY&&c.getPosition()<d.getPosition()||b==a.INTERRUPT_LATE&&c.getPosition()>
d.getPosition())d=c}return d!=null?(d.interrupt(),this.remove(d),true):false},toString:function(){return"[SoundJS SoundChannel]"}}})(window);(function(i){function a(){this.init()}function g(a){this.init(a)}function b(a){this.init(a)}a.MAX_INSTANCES=30;a.capabilities=null;a.lastId=0;a.AUDIO_READY="canplaythrough";a.AUDIO_ENDED="ended";a.AUDIO_ERROR="error";a.AUDIO_STALLED="stalled";a.fillChannels=false;a.isSupported=function(){if(BrowserDetect&&BrowserDetect.isIOS)return false;a.generateCapabilities();var c=a.tag;return c==null||c.canPlayType==null?false:true};a.generateCapabilities=function(){if(a.capabilities==null){var c=a.tag=document.createElement("audio");
a.capabilities={panning:false,volume:true,mp3:c.canPlayType("audio/mp3")!="no"&&c.canPlayType("audio/mp3")!="",ogg:c.canPlayType("audio/ogg")!="no"&&c.canPlayType("audio/ogg")!="",mpeg:c.canPlayType("audio/mpeg")!="no"&&c.canPlayType("audio/mpeg")!="",channels:a.MAX_INSTANCES}}};a.prototype={capabilities:null,FT:0.0010,channels:null,init:function(){this.capabilities=a.capabilities;this.channels={}},register:function(a,d){for(var e=b.get(a),f,g=0,h=d||1;g<h;g++)f=this.createTag(a),e.add(f);return{tag:f}},
createTag:function(a){var b=document.createElement("audio");b.preload=false;b.src=a;return b},create:function(a){a=new g(a);a.owner=this;return a},toString:function(){return"[HTMLAudioPlugin]"}};i.SoundJS.HTMLAudioPlugin=a;g.prototype={src:null,uniqueId:-1,playState:null,owner:null,loaded:false,paused:false,lastInterrupt:SoundJS.INTERRUPT_NONE,offset:0,delay:0,volume:1,pan:0,muted:false,remainingLoops:0,delayTimeout:-1,tag:null,onComplete:null,onLoop:null,onReady:null,onPlayFailed:null,onPlayInterrupted:null,
endedHandler:null,readyHandler:null,stalledHandler:null,init:function(c){this.uniqueId=a.lastId++;this.src=c;this.endedHandler=SoundJS.proxy(this.handleSoundComplete,this);this.readyHandler=SoundJS.proxy(this.handleSoundReady,this);this.stalledHandler=SoundJS.proxy(this.handleSoundStalled,this)},cleanUp:function(){var c=this.tag;if(c!=null){c.pause();try{c.currentTime=0}catch(d){}c.removeEventListener(a.AUDIO_ENDED,this.endedHandler,false);c.removeEventListener(a.AUDIO_READY,this.readyHandler,false);
b.setInstance(this.src,c);this.tag=null}SoundJS.playFinished(this)},interrupt:function(){if(this.tag!=null){this.playState=SoundJS.PLAY_INTERRUPTED;if(this.onPlayInterrupted)this.onPlayInterrupted(this);this.cleanUp();this.paused=false}},play:function(a,b,e,f,g,h){this.cleanUp();SoundJS.playInstance(this,a,b,e,f,g,h)},beginPlaying:function(c,d,e){var f=this.tag=b.getInstance(this.src);if(f==null)return this.playFailed(),-1;f.addEventListener(a.AUDIO_ENDED,this.endedHandler,false);this.offset=c;this.volume=
e;this.updateVolume();this.remainingLoops=d;f.readyState!==4?(f.addEventListener(a.AUDIO_READY,this.readyHandler,false),f.addEventListener(a.AUDIO_STALLED,this.stalledHandler,false),f.load()):this.handleSoundReady(null);return 1},handleSoundStalled:function(){SoundJS.log("* Audio Stalled");if(this.onPlayFailed!=null)this.onPlayFailed(this);this.cleanUp()},handleSoundReady:function(){this.playState=SoundJS.PLAY_SUCCEEDED;this.tag.removeEventListener(a.AUDIO_READY,this.readyHandler,false);this.offset>=
this.getDuration()?(SoundJS.log("* Out of range",this.offset,this.tag.currentTime),this.playFailed()):(this.tag.currentTime=this.offset*0.0010,this.tag.play())},pause:function(){this.paused=true;return this.tag!=null?(this.tag.pause(),false):true},resume:function(){this.paused=false;return this.tag!=null?(this.tag.play(),false):true},stop:function(){this.pause();this.playState=SoundJS.PLAY_FINISHED;this.cleanUp();return true},setMasterVolume:function(){this.updateVolume();return true},setVolume:function(a){this.volume=
a;this.updateVolume();return true},updateVolume:function(){return this.tag!=null?(this.tag.volume=this.muted?0:this.volume*SoundJS.masterVolume,true):false},getVolume:function(){return this.volume},mute:function(a){this.muted=a;this.updateVolume();return true},setPan:function(){return false},getPan:function(){return 0},getPosition:function(){return this.tag==null?0:this.tag.currentTime*1E3},setPosition:function(a){if(this.tag==null)return false;try{this.tag.currentTime=a*0.0010}catch(b){return false}return true},
getDuration:function(){return this.tag==null?0:this.tag.duration*1E3},handleSoundComplete:function(){if(this.remainingLoops!=0){this.remainingLoops--;try{this.tag.currentTime=0}catch(a){}this.tag.play();if(this.onLoop!=null)this.onLoop(this)}else{this.playState=SoundJS.PLAY_FINISHED;if(this.onComplete!=null)this.onComplete(this);this.cleanUp()}},playFailed:function(){this.playState=SoundJS.PLAY_FAILED;if(this.onPlayFailed!=null)this.onPlayFailed(this);this.cleanUp()},toString:function(){return"[HTMLAudio SoundInstance]"}};
b.channels={};b.get=function(a){var d=b.channels[a];d==null&&(d=b.channels[a]=new b(a));return d};b.getInstance=function(a){a=b.channels[a];return a==null?null:a.get()};b.setInstance=function(a,d){var e=b.channels[a];return e==null?null:e.set(d)};b.prototype={src:null,length:0,available:0,tags:null,init:function(a){this.src=a;this.tags=[]},add:function(a){this.tags.push(a);this.length++;this.available=this.tags.length},get:function(){if(this.tags.length==0)return null;this.available=this.tags.length;
var a=this.tags.pop();document.body.appendChild(a);return a},set:function(a){this.tags.indexOf(a)==-1&&this.tags.push(a);document.body.removeChild(a);this.available=this.tags.length},toString:function(){return"[HTMLAudioPlugin TagChannel]"}}})(window);
